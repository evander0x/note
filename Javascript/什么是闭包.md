# 什么是闭包

闭包（Closure）是指有权访问另一个函数作用域中的变量的函数。
在 JavaScript 中，函数内部可以访问外部函数的变量，这种机制称为闭包。

> “函数对象可以通过作用域链相互关联起来，函数体内部的变量都可以保存在函数作用域内，这种特性在计算机科
> 学文献中称为“闭包”.”
> ——《JavaScript 权威指南（第六版）》

## 闭包的实现

通常是在嵌套函数中实现的，例如：

```js
function createComparisonFunction(propertyName) {
  return function (object1, object2) {
    let value1 = object1[propertyName];
    let value2 = object2[propertyName];
    if (value1 < value2) {
      return -1;
    } else if (value1 > value2) {
      return 1;
    } else {
      return 0;
    }
  };
}
```

上例中，返回的匿名函数就形成了闭包，它可以访问 `propertyName` 变量。

## 闭包的用途

1. **创建私有变量**

   ```js
   function Counter() {
     let count = 0;
     return function () {
       count++;
       return count;
     };
   }
   const counter = Counter();
   console.log(counter()); // 1
   console.log(counter()); // 2
   ```

2. **状态保持**

   ```js
   function makeAdder(x) {
     return function (y) {
       return x + y;
     };
   }
   const add5 = makeAdder(5);
   console.log(add5(2)); // 7
   ```

## 面试相关题目

### 例题 1：setTimeout 与闭包

```js
for (var i = 1; i <= 3; i++) {
  setTimeout(function () {
    console.log(i);
  }, 1000);
}
// 输出：4 4 4
```

**原因**：setTimeout 的回调函数形成了闭包，引用了外部的 `i`。循环结束后，`i` 变为 4，所有回调输出的都是 4。

### 如何解决？

#### 1. 立即执行函数（IIFE）

```js
for (var i = 1; i <= 3; i++) {
  (function (j) {
    setTimeout(function () {
      console.log(j);
    }, 1000);
  })(i);
}
// 输出：1 2 3
```

#### 2. 使用 let（块级作用域）

```js
for (let i = 1; i <= 3; i++) {
  setTimeout(function () {
    console.log(i);
  }, 1000);
}
// 输出：1 2 3
```

---

## 回答示例

**面试官：什么是闭包？请举例说明。**

答：闭包是指有权访问另一个函数作用域中变量的函数。通常是在嵌套函数中实现的。

作用：

- 实现数据的私有化，保护变量不被外部直接访问。
- 保持函数执行时的上下文状态，实现状态持久化。

注意：

- 闭包会导致其引用的外部变量无法被及时回收，可能造成内存泄漏，需注意释放无用引用。
- 闭包中的变量是共享的，多个闭包引用同一变量时要注意数据被意外修改。
